---
import ProjectCard from '@components/ProjectCard.astro';
import SiteLayout from '@components/SiteLayout.astro';
import { getCoverAsset, getPublishedProjects, getSiteContent } from '@lib/catalog';

const projects = getPublishedProjects();
const siteContent = getSiteContent();
const footerLines = String(siteContent.footerText || '')
  .split(/\r?\n/g)
  .map((line) => line.trim())
  .filter(Boolean);
---

<SiteLayout title="Raymondo Portfolio" description="Graphic and 3D design portfolio for Raymondo.">
  <main class="shell">
    <header class="site-header" data-mobile-nav>
      <h1 class="brand">Raymondo</h1>
      <button
        type="button"
        class="mobile-nav-toggle"
        data-mobile-nav-toggle
        aria-expanded="false"
        aria-controls="homeSiteNav"
        aria-label="Open navigation menu"
      >
        <span class="mobile-nav-toggle-icon" aria-hidden="true"></span>
      </button>
      <nav class="site-nav" id="homeSiteNav" data-mobile-nav-panel>
        <a href="#work">Work</a>
        <a href="#about">About</a>
        <a href="mailto:raymondartguy@gmail.com">Contact</a>
      </nav>
    </header>

    <section class="hero" id="about">
      <h2>{siteContent.heroTitle}</h2>
      <p>{siteContent.heroSubtitle}</p>
    </section>

    <section id="work" aria-label="Portfolio projects">
      <div class="filter-bar" id="filterBar">
        <button class="filter-chip" data-filter="all" aria-pressed="true" type="button">All</button>
        <button class="filter-chip" data-filter="graphic" aria-pressed="false" type="button">Graphic</button>
        <button class="filter-chip" data-filter="3d" aria-pressed="false" type="button">3D</button>
      </div>
      <div class="gallery-grid" id="galleryGrid">
        {projects.map((project) => <ProjectCard project={project} coverAsset={getCoverAsset(project)} />)}
      </div>
    </section>

    <footer class="site-footer">
      {footerLines.map((line) => <p>{line}</p>)}
    </footer>
  </main>

  <script>
    const chips = Array.from(document.querySelectorAll('.filter-chip'));
    const cards = Array.from(document.querySelectorAll('#galleryGrid .card'));
    const supportsObserver = 'IntersectionObserver' in window;
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    function applyFilter(nextFilter, activeChip) {
      const filter = String(nextFilter || 'all').toLowerCase();

      chips.forEach((item) => {
        item.setAttribute('aria-pressed', item === activeChip ? 'true' : 'false');
      });

      cards.forEach((card) => {
        const discipline = String(card.dataset.discipline || '').toLowerCase();
        const match = filter === 'all' || discipline === filter;
        if (match) {
          card.removeAttribute('hidden');
        } else {
          card.setAttribute('hidden', '');
        }
      });
    }

    chips.forEach((chip) => {
      chip.addEventListener('click', () => {
        applyFilter(chip.dataset.filter, chip);
      });
    });

    function revealAllCards() {
      cards.forEach((card) => {
        card.classList.remove('is-reveal-pending');
        card.classList.add('is-revealed');
      });
    }

    function initCardReveal() {
      if (!cards.length) return;
      if (!supportsObserver || prefersReducedMotion) {
        revealAllCards();
        return;
      }

      cards.forEach((card, index) => {
        card.classList.add('is-reveal-pending');
        card.style.setProperty('--reveal-delay', `${Math.min(index * 55, 330)}ms`);
      });

      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (!entry.isIntersecting) return;
            const card = entry.target;
            card.classList.remove('is-reveal-pending');
            card.classList.add('is-revealed');
            observer.unobserve(card);
          });
        },
        {
          threshold: 0.16,
          rootMargin: '0px 0px -7% 0px'
        }
      );

      cards.forEach((card) => observer.observe(card));
    }

    initCardReveal();
  </script>
</SiteLayout>
