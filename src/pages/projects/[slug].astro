---
import ModelViewer from '@components/ModelViewer.astro';
import SiteLayout from '@components/SiteLayout.astro';
import { getAssetGroup, getCoverAsset, getPublishedProjects } from '@lib/catalog';

export function getStaticPaths() {
  return getPublishedProjects().map((project) => ({
    params: { slug: project.slug },
    props: { project }
  }));
}

const { project } = Astro.props;
const cover = getCoverAsset(project);
const imageAssets = getAssetGroup(project, 'image');
const modelAsset = getAssetGroup(project, 'model3d')[0];
const posterAsset = getAssetGroup(project, 'poster')[0] ?? cover;
const moodboard = imageAssets.filter((asset) => !cover || asset.id !== cover.id);
const hasModelHero = project.discipline === '3d' && Boolean(modelAsset);
const showsCoverImage = Boolean(cover) && !hasModelHero;
const moodboardLightboxOffset = showsCoverImage ? 1 : 0;
const normalizeText = (value) => String(value ?? '').replace(/\u00a0/g, ' ').trim();
const themeInspiration = normalizeText(project.themeInspiration);
const styleDirection = normalizeText(project.styleDirection);
const typographyNotes = normalizeText(project.typographyNotes);
const motifSummary = normalizeText(project.motifSummary);
const toolingNotes = normalizeText(project.toolingNotes);
const materialNotes = normalizeText(project.materialNotes);
const palette = (Array.isArray(project.palette) ? project.palette : [])
  .map((color) => String(color ?? '').trim())
  .filter(Boolean);
const hasMetadataPanel =
  Boolean(themeInspiration) ||
  Boolean(styleDirection) ||
  Boolean(typographyNotes) ||
  Boolean(motifSummary) ||
  (project.discipline === '3d' && (Boolean(toolingNotes) || Boolean(materialNotes))) ||
  palette.length > 0;
const lightboxImages = [
  ...(showsCoverImage && cover ? [cover] : []),
  ...moodboard
].map((asset) => ({
  id: asset.id,
  url: asset.url,
  alt: asset.altText || `${project.title} project image`,
  caption: asset.caption || ''
}));
const templateClass = `template-${project.styleTemplate}`;
---

<SiteLayout title={`${project.title} | Raymondo`} description={project.descriptionShort}>
  <main class={`project-shell ${templateClass}`}>
    <header class="site-header" data-mobile-nav>
      <h1 class="brand"><a href="/" style="text-decoration:none;">Raymondo</a></h1>
      <button
        type="button"
        class="mobile-nav-toggle"
        data-mobile-nav-toggle
        aria-expanded="false"
        aria-controls="projectSiteNav"
        aria-label="Open navigation menu"
      >
        <span class="mobile-nav-toggle-icon" aria-hidden="true"></span>
      </button>
      <nav class="site-nav" id="projectSiteNav" data-mobile-nav-panel>
        <a href="/">Back to Work</a>
        <a href="mailto:raymondartguy@gmail.com">Contact</a>
      </nav>
    </header>

    <section class="project-hero">
      <p class="tag-row">
        <span class="tag">{project.discipline === '3d' ? '3D Project' : 'Graphic Project'}</span>
        {project.year && <span class="tag">{project.year}</span>}
        {project.tags.map((tag) => <span class="tag">{tag}</span>)}
      </p>
      <h1>{project.title}</h1>
      <p>{project.descriptionLong || project.descriptionShort}</p>
    </section>

    <section class={`project-layout${hasMetadataPanel ? '' : ' project-layout-single'}`}>
      <article class="project-main">
        <div class="media-stage">
          {
            hasModelHero ? (
              <ModelViewer src={modelAsset.url} poster={posterAsset?.url} alt={modelAsset.altText || project.title} />
            ) : cover ? (
              <button
                type="button"
                class="project-image-button project-lightbox-trigger"
                data-lightbox-index="0"
                aria-label={`Open image 1 of ${lightboxImages.length}`}
              >
                <img src={cover.url} alt={cover.altText || project.title} />
              </button>
            ) : (
              <div style="height:100%;display:grid;place-items:center;min-height:420px;">No media published yet.</div>
            )
          }
        </div>
      </article>

      {hasMetadataPanel && (
        <aside class="project-panel">
          {themeInspiration && (
            <div class="panel-block">
              <h3>Inspiration & Theme</h3>
              <p>{themeInspiration}</p>
            </div>
          )}

          {styleDirection && (
            <div class="panel-block">
              <h3>Design DNA</h3>
              <p>{styleDirection}</p>
            </div>
          )}

          {typographyNotes && (
            <div class="panel-block">
              <h3>Typography Notes</h3>
              <p>{typographyNotes}</p>
            </div>
          )}

          {motifSummary && (
            <div class="panel-block">
              <h3>Motif Summary</h3>
              <p>{motifSummary}</p>
            </div>
          )}

          {project.discipline === '3d' && toolingNotes && (
            <div class="panel-block">
              <h3>Tooling</h3>
              <p>{toolingNotes}</p>
            </div>
          )}

          {project.discipline === '3d' && materialNotes && (
            <div class="panel-block">
              <h3>Material Notes</h3>
              <p>{materialNotes}</p>
            </div>
          )}

          {palette.length > 0 && (
            <div class="panel-block">
              <h3>Palette</h3>
              <div class="palette">
                {palette.map((color) => <span class="swatch" style={`background:${color}`} title={color}></span>)}
              </div>
            </div>
          )}
        </aside>
      )}
    </section>

    {moodboard.length > 0 && (
      <section>
        <h2 style="font-family:var(--font-display);font-size:1rem;letter-spacing:0.08em;text-transform:uppercase;margin:1.2rem 0 0.7rem;">
          Moodboard / Supporting Frames
        </h2>
        <div class="moodboard">
          {moodboard.map((asset, index) => (
            <figure>
              <button
                type="button"
                class="project-image-button project-lightbox-trigger"
                data-lightbox-index={String(index + moodboardLightboxOffset)}
                aria-label={`Open image ${index + moodboardLightboxOffset + 1} of ${lightboxImages.length}`}
              >
                <img src={asset.url} alt={asset.altText || `${project.title} supporting visual`} loading="lazy" />
              </button>
            </figure>
          ))}
        </div>
      </section>
    )}

    {lightboxImages.length > 0 && (
      <dialog id="projectLightbox" class="project-lightbox" aria-label={`${project.title} image viewer`}>
        <article class="project-lightbox-card">
          <button
            type="button"
            class="project-lightbox-close"
            data-lightbox-close
            aria-label="Close image viewer"
            title="Close"
          >
            ×
          </button>
          <button type="button" class="project-lightbox-nav prev" data-lightbox-prev aria-label="Previous image" title="Previous">
            ‹
          </button>
          <figure class="project-lightbox-figure">
            <div class="project-lightbox-stage" id="projectLightboxStage" data-lightbox-stage>
              <img id="projectLightboxImage" src="" alt="" draggable="false" />
            </div>
            <p id="projectLightboxCounter" class="project-lightbox-counter"></p>
          </figure>
          <button type="button" class="project-lightbox-nav next" data-lightbox-next aria-label="Next image" title="Next">
            ›
          </button>
        </article>
      </dialog>
    )}
  </main>

  {
    project.discipline === '3d' &&
      modelAsset && (
        <script
          is:inline
          type="module"
          src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.5.0/model-viewer.min.js"
        ></script>
      )
  }

  {
    lightboxImages.length > 0 && (
      <script is:inline define:vars={{ lightboxImages }}>
        const images = Array.isArray(lightboxImages) ? lightboxImages : [];
        const lightbox = document.getElementById('projectLightbox');
        const imageEl = document.getElementById('projectLightboxImage');
        const stageEl = document.getElementById('projectLightboxStage');
        const counterEl = document.getElementById('projectLightboxCounter');
        const closeBtn = lightbox?.querySelector('[data-lightbox-close]');
        const prevBtn = lightbox?.querySelector('[data-lightbox-prev]');
        const nextBtn = lightbox?.querySelector('[data-lightbox-next]');

        if (
          lightbox instanceof HTMLDialogElement &&
          imageEl &&
          stageEl &&
          counterEl &&
          images.length > 0
        ) {
          let activeIndex = 0;

          const wrapIndex = (index) => {
            const total = images.length;
            return ((index % total) + total) % total;
          };

          const renderSlide = (index) => {
            activeIndex = wrapIndex(index);
            const current = images[activeIndex];
            imageEl.src = current.url || '';
            imageEl.alt = current.alt || '';
            counterEl.textContent = `${activeIndex + 1} / ${images.length}`;
          };

          const openAt = (index) => {
            renderSlide(index);
            if (!lightbox.open) {
              lightbox.showModal();
              document.body.classList.add('lightbox-open');
            }
          };

          const closeLightbox = () => {
            if (lightbox.open) lightbox.close();
          };

          document.addEventListener('click', (event) => {
            const target = event.target;
            if (!(target instanceof Element)) return;
            const trigger = target.closest('.project-lightbox-trigger');
            if (!(trigger instanceof HTMLElement)) return;

            const index = Number(trigger.dataset.lightboxIndex ?? 0);
            openAt(Number.isFinite(index) ? index : 0);
          });

          lightbox.addEventListener('click', (event) => {
            if (event.target === lightbox) {
              closeLightbox();
            }
          });

          lightbox.addEventListener('close', () => {
            document.body.classList.remove('lightbox-open');
          });

          document.addEventListener('keydown', (event) => {
            if (!lightbox.open) return;
            if (event.key === 'ArrowRight') {
              event.preventDefault();
              renderSlide(activeIndex + 1);
            } else if (event.key === 'ArrowLeft') {
              event.preventDefault();
              renderSlide(activeIndex - 1);
            } else if (event.key === 'Escape') {
              event.preventDefault();
              closeLightbox();
            }
          });

          stageEl.addEventListener('dragstart', (event) => {
            event.preventDefault();
          });

          closeBtn?.addEventListener('click', closeLightbox);
          prevBtn?.addEventListener('click', () => renderSlide(activeIndex - 1));
          nextBtn?.addEventListener('click', () => renderSlide(activeIndex + 1));
        }
      </script>
    )
  }
</SiteLayout>
